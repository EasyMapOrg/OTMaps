define(["app/tool/OTMaps/Utils/ColorUtil","esri/Color","app/tool/OTMaps/components/Legend","esri/symbols/TextSymbol","esri/geometry/Polygon","esri/geometry/Point","esri/layers/LabelClass","esri/symbols/Font","esri/InfoTemplate","esri/layers/FeatureLayer","esri/tasks/query","esri/graphic","esri/geometry/Extent","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol","esri/renderers/smartMapping","esri/renderers/ClassBreaksRenderer","esri/renderers/HeatmapRenderer"],function(e,t,a,r,o,n,s,i,l,f,u,d,g,y,h,p,c,m,M){function w(){}var T="tagForDiffColor";return w.prototype.createSLayer=function(e,t){if(!e.draw||!e.clear)return!1;var a=e.config.layer;if("string"==typeof e.config.layer.statTag&&(e.config.layer.statTag=[e.config.layer.statTag]),!e.map)throw new Error("OTMaps Error 1001：[map] is required in config,use [setConfig] method to fix it");if(!a.statTag.length&&!a.baseTag&&"Heat"!=e.type||!a.url)throw new Error("OTMaps Error 1002：some required params absent in layer config,use [setConfig] or [setLayer] method to fix it");var r=e.config.popup.show?new l(e.config.popup):null,o=new f(a.url,{mode:f.MODE_SNAPSHOT,opacity:1}),n=new u;n.outFields=["*"],n.where="1=1",o.queryFeatures(n,function(o){o.fields.push({name:T,alias:"区分颜色",type:"esriFieldTypeDouble"});var n=[];o.features.forEach(function(e,t){var a={};for(var r in e.attributes)a[r]=e.attributes[r];a[T]=t;var o=new d(e.geometry);o.setAttributes(a),n.push(o)}),e._features=n;var s={layerDefinition:{geometryType:o.geometryType,fields:o.fields},featureSet:{features:[],geometryType:o.geometryType}};e.drawLayer=e.shareProp.drawLayer=new f(s,{id:a.id,mode:f.MODE_SNAPSHOT,infoTemplate:r,opacity:1}),e._binded&&e._binded.remove(),e._binded=e.map.on("layers-add-result",function(){e.drawLayer.applyEdits(n,null,null),t&&t()}),e.map.addLayers([e.drawLayer])})},w.prototype.createMLayer=function(e,t){var a=this;if(!e.draw||!e.clear)return!1;var r=e.config.layer;if("string"==typeof e.config.layer.statTag&&(e.config.layer.statTag=[e.config.layer.statTag]),!e.map)throw new Error("OTMaps Error 1001：[map] is required in config,use [setConfig] method to fix it");if(!r.url||!r.corString.length||!r.statTag.length&&!r.baseTag)throw new Error("OTMaps Error 1002：some required params absent in layer config,use [setConfig] or [setLayer] method to fix it");var o=e.config.popup.show?new l(e.config.popup):null,n=new f(r.url,{mode:f.MODE_SNAPSHOT,opacity:1}),s=new u;s.outFields=["*"],s.where="1=1",n.queryFeatures(s,function(n){n.fields.push({name:T,alias:"区分颜色",type:"esriFieldTypeDouble"}),r.baseTag&&n.fields.push({name:r.baseTag,alias:"底图统计数据",type:"esriFieldTypeDouble"}),r.statTag.length&&r.statTag.forEach(function(e,t){n.fields.push({name:e,alias:"统计数据"+t,type:"esriFieldTypeDouble"})});var s=[];n.features.forEach(function(e,t){var o={};o[T]=t;for(var n in e.attributes)o[n]=e.attributes[n];!a.getCorData(r.statData,e,r.corString,r.baseTag)==!1&&(o[r.baseTag]=a.getCorData(r.statData,e,r.corString,r.baseTag)),r.statTag.length&&r.statTag.forEach(function(t){!a.getCorData(r.statData,e,r.corString,t)==!1&&(o[t]=a.getCorData(r.statData,e,r.corString,t))});var i=new d(e.geometry);i.setAttributes(o),s.push(i)}),e._features=s;var i={layerDefinition:{geometryType:n.geometryType,fields:n.fields},featureSet:{features:[],geometryType:n.geometryType}};e.drawLayer=e.shareProp.drawLayer=new f(i,{id:r.id,mode:f.MODE_SNAPSHOT,infoTemplate:o,opacity:1}),e._binded&&e._binded.remove(),e._binded=e.shareProp._binded=e.map.on("layers-add-result",function(){e.drawLayer.applyEdits(s,null,null),t&&t()}),e.map.addLayers([e.drawLayer])})},w.prototype.createLabel=function(e){if(!e.draw||!e.clear)return!1;var t=e.config.label;if(!t.field)throw new Error("OTMaps Error 1003：[field] is required in label config,use [setConfig] method to fix it");e._features.forEach(function(a){var o=a.geometry,s=o.getCentroid(),l=new n(s.x+t.xoffset,s.y+t.yoffset,a.spatialReference),f=new r(a.attributes[t.field]).setColor(t.color);f.font.setSize(t.size+"pt"),t.bold&&f.font.setWeight(i.WEIGHT_BOLD),f.font.setFamily(t.family),e.drawLayer.add(new d(l,f))})},w.prototype.createLegend=function(e){if(!e.draw||!e.clear)return!1;var t=e.config.legend;if(!t.id)throw new Error("OTMaps Error 1004：[id] is required in label config,use [setConfig] method to fix it");e.shareProp.legend&&e.shareProp.legend.destroy(),e.legend=e.shareProp.legend=new a({map:e.map,id:t.id,title:t.title,info:e._legendInfo}),e.legend.startup()},w.prototype.drawRange=function(a,r){var o=a.config.layer.baseTag,n=a.config.style;c.createClassedColorRenderer({layer:a.drawLayer,field:o,basemap:"topo",classificationMethod:n.classicMethod,numClasses:5}).then(function(s){var i=new m(null,o),l=e.getGradientColor("#ddd",n.baseColor,s.classBreakInfos.length+1);a._classBreakInfos=s.classBreakInfos;var f=[];s.classBreakInfos.forEach(function(e,a){f.push({color:l[a+1],value:e.minValue+"-"+e.maxValue});var r=new y;r.setColor(new t(l[a+1])),r.setOutline(new h(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new t([75,75,75,.8]),1)),i.addBreak(e.minValue,e.maxValue,r)}),a._legendInfo.push(f),a.drawLayer.setRenderer(i),r&&r()})},w.prototype.drawUnique=function(e,t){e.config.style;c.createTypeRenderer({layer:e.drawLayer,field:T,basemap:"streets",numTypes:-1}).then(function(a){e.drawLayer.setRenderer(a.renderer),t&&t()})},w.prototype.drawHistogram=function(a){function r(){var e=[];return a._features.forEach(function(t){for(var a=0;a<n.statTag.length;a++)e.push(t.attributes[n.statTag[a]])}),e.sort(function(e,t){return e-t}),e[e.length-1]}function o(){var e=[];n.statTag.forEach(function(t,a){e.push({color:f[a],value:t})}),a._legendInfo.push(e)}var n=a.config.layer,s=(a._features[0]._extent.ymax-a._features[0]._extent.ymin)/3*2,i=s/5,l=r(),f=e.getGradientColor(a.config.style.statColor,"#ddd",n.statTag.length+1).slice(0,n.statTag.length);a._features.forEach(function(e){for(var r=0;r<n.statTag.length;r++){var o=e.geometry,u=o.getCentroid(),p=u.x-i*n.statTag.length/2,c=u.y,m=p+r*i,M=p+(r+1)*i,w=e.attributes[n.statTag[r]],T=u.y+s*w/l,P=new g(m,c,M,T,e.spatialReference),I=(new y).setColor(f[r]);I.setOutline(new h(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new t([75,75,75,.5]),.5)),a.drawLayer.add(new d(P,I))}}),o()},w.prototype.drawPie=function(a){function r(){var e=[];i.statTag.forEach(function(t,a){e.push({color:l[a],value:t})}),a._legendInfo.push(e)}function n(e,t,r,o){var n=1e-6,s=50,i=e.x,l=e.y,f=(a._features[0]._extent.ymax-a._features[0]._extent.ymin)/4;if(r<Math.PI/2&&o<=Math.PI/2)for(var u=i+Math.cos(o)*f,d=i+Math.cos(r)*f,g=d-u,y=s-1;y>=0;--y){var h=u+g*(1*y/(s-1)),p=f*f-(h-i)*(h-i),c=l+Math.sqrt(0>p?0:p);t[t.length]=[h,c]}else if(r>=Math.PI/2&&o<=Math.PI)for(var u=i+Math.cos(o)*f,d=i+Math.cos(r)*f,g=d-u,y=s-1;y>=0;--y){var h=u+g*(1*y/(s-1)),p=f*f-(h-i)*(h-i),c=l+Math.sqrt(0>p?0:p);t[t.length]=[h,c]}else if(r>=Math.PI&&o<=3*Math.PI/2)for(var u=i+Math.cos(o)*f,d=i+Math.cos(r)*f,g=d-u,y=s-1;y>=0;--y){var h=u+g*(1*y/(s-1)),p=f*f-(h-i)*(h-i),c=l-Math.sqrt(0>p?0:p);t[t.length]=[h,c]}else if(r>=3*Math.PI/2-n&&o<=2*Math.PI+n)for(var u=i+Math.cos(o)*f,d=i+Math.cos(r)*f,g=d-u,y=s-1;y>=0;--y){var h=u+g*(1*y/(s-1)),p=f*f-(h-i)*(h-i),c=l-Math.sqrt(0>p?0:p);t[t.length]=[h,c]}}function s(e,t,a,r){a<Math.PI/2&&r>Math.PI/2&&r<=Math.PI?(n(e,t,a,Math.PI/2),n(e,t,Math.PI/2,r)):a<Math.PI/2&&r>Math.PI&&r<=3*Math.PI/2?(n(e,t,a,Math.PI/2),n(e,t,Math.PI/2,Math.PI),n(e,t,Math.PI,r)):a<Math.PI/2&&r>3*Math.PI/2&&r<=2*Math.PI?(n(e,t,a,Math.PI/2),n(e,t,Math.PI/2,Math.PI),n(e,t,Math.PI,3*Math.PI/2),n(e,t,3*Math.PI/2,r)):a>=Math.PI/2&&a<Math.PI&&r>Math.PI&&r<=3*Math.PI/2?(n(e,t,a,Math.PI),n(e,t,Math.PI,r)):a>=Math.PI/2&&a<Math.PI&&r>3*Math.PI/2?(n(e,t,a,Math.PI),n(e,t,Math.PI,3*Math.PI/2),n(e,t,3*Math.PI/2,r)):a>=Math.PI&&a<3*Math.PI/2&&r>3*Math.PI/2?(n(e,t,a,3*Math.PI/2),n(e,t,3*Math.PI/2,r)):n(e,t,a,r)}var i=a.config.layer,l=e.getGradientColor(a.config.style.statColor,"#ddd",i.statTag.length+1).slice(0,i.statTag.length);a._features.forEach(function(e){var r=e.geometry,n=r.getCentroid(),f=0,u=0,g=0;i.statTag.forEach(function(t){f+=e.attributes[t]}),i.statTag.forEach(function(r,i){var p=e.attributes[r];g=u+2*Math.PI*p/f;var c=[],m=(new y).setColor(l[i]);m.setOutline(new h(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new t([60,60,60,.6]),1)),c.push([n.x,n.y]),s(n,c,u,g),c.push([n.x,n.y]);var M=new o(c);a.drawLayer.add(new d(M,m)),u=g})}),r()},w.prototype.drawHeat=function(e){var t=Array.prototype.slice.call(e.config.style.colorStops,0),a=new M({colorStops:t,blurRadius:e.config.style.heatPower,maxPixelIntensity:150,minPixelIntensity:0});e.drawLayer.setRenderer(a)},w.prototype.getCorData=function(e,t,a,r){for(var o=0;o<e.length;o++){var n=0;if(a.forEach(function(a){var r=a.substring(0,a.indexOf("=")),s=a.substring(a.indexOf("=")+1);r.indexOf("&")<0?e[o][r]==t.attributes[s]&&n++:(r=r.substring(1),e[o][r]==s&&n++)}),n==a.length&&0!=n)return parseFloat(e[o][r])}return!1},new w});