define(["OTMap/Utils/ColorUtil","esri/Color","OTMap/components/Legend","esri/symbols/TextSymbol","esri/geometry/Polygon","esri/geometry/Point","esri/geometry/Circle","esri/layers/LabelClass","esri/symbols/Font","esri/InfoTemplate","esri/layers/FeatureLayer","esri/tasks/query","esri/graphic","esri/geometry/Extent","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol","esri/renderers/smartMapping","esri/renderers/ClassBreaksRenderer","esri/renderers/HeatmapRenderer"],function(e,t,r,a,o,n,i,s,l,f,u,h,d,y,c,g,p,m,w,M){function b(){}var P="tagForDiffColor";return b.prototype.createSLayer=function(e,t){var r=this;if(!e.draw||!e.clear)return!1;var a=e.config.layer,o=e.config.popup.show?new f(e.config.popup):null,n=new u(a.url,{mode:u.MODE_SNAPSHOT,opacity:1}),i=new h;return i.outFields=["*"],i.where="1=1",n.queryFeatures(i,function(r){r.fields.push({name:P,alias:"区分颜色",type:"esriFieldTypeDouble"});var n=[];r.features.forEach(function(e,t){var r={};for(var a in e.attributes)r[a]=e.attributes[a];r[P]=t;var o=new d(e.geometry);o.setAttributes(r),n.push(o)}),e._features=n;var i={layerDefinition:{geometryType:r.geometryType,fields:r.fields},featureSet:{features:[],geometryType:r.geometryType}};e.drawLayer=e.shareProp.drawLayer=new u(i,{id:a.id,mode:u.MODE_SNAPSHOT,infoTemplate:o,opacity:1}),e.shareProp._binded&&e.shareProp._binded.remove(),e.shareProp._binded=e.shareProp.map.on("layers-add-result",function(){e.drawLayer.applyEdits(n,null,null),t&&t()}),e.map.addLayers([e.drawLayer])}),r},b.prototype.createMLayer=function(e,t){var r=this;if(!e.draw||!e.clear)return!1;var a=e.config.layer;"string"==typeof e.config.layer.statTag&&(e.config.layer.statTag=[e.config.layer.statTag]);var o=e.config.popup.show?new f(e.config.popup):null,n=new u(a.url,{mode:u.MODE_SNAPSHOT,opacity:1}),i=new h;return i.outFields=["*"],i.where="1=1",n.queryFeatures(i,function(n){n.fields.push({name:P,alias:"区分颜色",type:"esriFieldTypeDouble"}),a.baseTag&&n.fields.push({name:a.baseTag,alias:"底图统计数据",type:"esriFieldTypeDouble"}),a.statTag.length&&a.statTag.forEach(function(e,t){n.fields.push({name:e,alias:"统计数据"+t,type:"esriFieldTypeDouble"})});var i=[];n.features.forEach(function(e,t){var o={};o[P]=t;for(var n in e.attributes)o[n]=e.attributes[n];r.getCorData(a.statData,e,a.corString,a.baseTag)!==!1&&(o[a.baseTag]=r.getCorData(a.statData,e,a.corString,a.baseTag)),a.statTag.length&&a.statTag.forEach(function(t){r.getCorData(a.statData,e,a.corString,t)!==!1&&(o[t]=r.getCorData(a.statData,e,a.corString,t))});var s=new d(e.geometry);s.setAttributes(o),i.push(s)}),e._features=i;var s={layerDefinition:{geometryType:n.geometryType,fields:n.fields},featureSet:{features:[],geometryType:n.geometryType}};e.drawLayer=e.shareProp.drawLayer=new u(s,{id:a.id,mode:u.MODE_SNAPSHOT,infoTemplate:o,opacity:1}),e.shareProp._binded&&e.shareProp._binded.remove(),e.shareProp._binded=e.shareProp._binded=e.map.on("layers-add-result",function(){e.drawLayer.applyEdits(i,null,null),t&&t()}),e.map.addLayers([e.drawLayer])}),r},b.prototype.createLabel=function(e){var t=this;if(!e.draw||!e.clear)return!1;var r=e.config.label;return e._features.forEach(function(t){var o=t.geometry,i=o.getCentroid(),s=new n(i.x+r.xoffset,i.y+r.yoffset,t.spatialReference),f=new a(t.attributes[r.field]).setColor(r.color);f.font.setSize(r.size+"pt"),r.bold&&f.font.setWeight(l.WEIGHT_BOLD),f.font.setFamily(r.family),e.drawLayer.add(new d(s,f))}),t},b.prototype.createLegend=function(e){var t=this;if(!e.draw||!e.clear)return!1;var a=e.config.legend;return e.shareProp.legend&&e.shareProp.legend.destroy(),e.legend=e.shareProp.legend=new r({map:e.map,id:a.id,title:a.title,info:e._legendInfo}),e.legend.startup(),t},b.prototype.drawRange=function(r,a){var o=this,n=r.config.layer.baseTag,i=r.config.style;return m.createClassedColorRenderer({layer:r.drawLayer,field:n,basemap:"topo",classificationMethod:i.classicMethod,numClasses:5}).then(function(o){var s=new w(null,n),l=e.getGradientColor("#ddd",i.baseColor,o.classBreakInfos.length+1);r._classBreakInfos=o.classBreakInfos;var f=[];o.classBreakInfos.forEach(function(e,r){f.push({color:l[r+1],value:e.minValue+"-"+e.maxValue});var a=new c;a.setColor(new t(l[r+1])),a.setOutline(new g(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new t([75,75,75,.8]),1)),s.addBreak(e.minValue,e.maxValue,a)}),r._legendInfo.push(f),r.drawLayer.setRenderer(s),a&&a()}),o},b.prototype.drawUnique=function(e,t){var r=this;e.config.style;return m.createTypeRenderer({layer:e.drawLayer,field:P,basemap:"streets",numTypes:-1}).then(function(r){e.drawLayer.setRenderer(r.renderer),t&&t()}),r},b.prototype.drawHistogram=function(r){function a(){var e=r._features[0]._extent.ymax-r._features[0]._extent.ymin,t=r._features[0]._extent.ymax-r._features[0]._extent.ymin;return r._features.forEach(function(r){e=r._extent.ymax-r._extent.ymin<e?r._extent.ymax-r._extent.ymin:e,t=r._extent.ymax-r._extent.ymin>t?r._extent.ymax-r._extent.ymin:t}),(e+t)/2}function o(){var e=[];return r._features.forEach(function(t){for(var r=0;r<s.statTag.length;r++)e.push(t.attributes[s.statTag[r]])}),e.sort(function(e,t){return e-t}),e[e.length-1]}function n(){var e=[];s.statTag.forEach(function(t,a){e.push({color:p[a],value:r.config.legend.itemTitle[a]||"默认指标名"})}),r._legendInfo.push(e)}var i=this,s=r.config.layer,l=a(),f=l/2,u=f/5,h=o(),p=e.getGradientColor(r.config.style.statColor,"#ddd",s.statTag.length+1).slice(0,s.statTag.length);return r._features.forEach(function(e){for(var a=0;a<s.statTag.length;a++){var o=e.geometry,n=o.getCentroid(),i=n.x-u*s.statTag.length/2,l=n.y,m=i+a*u,w=i+(a+1)*u,M=e.attributes[s.statTag[a]],b=n.y+f*M/h,P=new y(m,l,w,b,e.spatialReference),T=(new c).setColor(p[a]);T.setOutline(new g(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new t([75,75,75,.5]),.5)),r.drawLayer.add(new d(P,T))}}),n(),i},b.prototype.drawPie=function(r){function a(){var e=[];f.statTag.forEach(function(t,a){e.push({color:u[a],value:r.config.legend.itemTitle[a]||"默认指标名"})}),r._legendInfo.push(e)}function n(e,t,r,a,o){var n=1e-6,i=50,s=e.x,l=e.y;if(r<Math.PI/2&&a<=Math.PI/2)for(var f=s+Math.cos(a)*o,u=s+Math.cos(r)*o,h=u-f,d=i-1;d>=0;--d){var y=f+h*(1*d/(i-1)),c=o*o-(y-s)*(y-s),g=l+Math.sqrt(0>c?0:c);t[t.length]=[y,g]}else if(r>=Math.PI/2&&a<=Math.PI)for(var f=s+Math.cos(a)*o,u=s+Math.cos(r)*o,h=u-f,d=i-1;d>=0;--d){var y=f+h*(1*d/(i-1)),c=o*o-(y-s)*(y-s),g=l+Math.sqrt(0>c?0:c);t[t.length]=[y,g]}else if(r>=Math.PI&&a<=3*Math.PI/2)for(var f=s+Math.cos(a)*o,u=s+Math.cos(r)*o,h=u-f,d=i-1;d>=0;--d){var y=f+h*(1*d/(i-1)),c=o*o-(y-s)*(y-s),g=l-Math.sqrt(0>c?0:c);t[t.length]=[y,g]}else if(r>=3*Math.PI/2-n&&a<=2*Math.PI+n)for(var f=s+Math.cos(a)*o,u=s+Math.cos(r)*o,h=u-f,d=i-1;d>=0;--d){var y=f+h*(1*d/(i-1)),c=o*o-(y-s)*(y-s),g=l-Math.sqrt(0>c?0:c);t[t.length]=[y,g]}}function s(e,t,r,a,o){r<Math.PI/2&&a>Math.PI/2&&a<=Math.PI?(n(e,t,r,Math.PI/2,o),n(e,t,Math.PI/2,a,o)):r<Math.PI/2&&a>Math.PI&&a<=3*Math.PI/2?(n(e,t,r,Math.PI/2,o),n(e,t,Math.PI/2,Math.PI,o),n(e,t,Math.PI,a,o)):r<Math.PI/2&&a>3*Math.PI/2&&a<=2*Math.PI?(n(e,t,r,Math.PI/2,o),n(e,t,Math.PI/2,Math.PI,o),n(e,t,Math.PI,3*Math.PI/2,o),n(e,t,3*Math.PI/2,a,o)):r>=Math.PI/2&&r<Math.PI&&a>Math.PI&&a<=3*Math.PI/2?(n(e,t,r,Math.PI,o),n(e,t,Math.PI,a,o)):r>=Math.PI/2&&r<Math.PI&&a>3*Math.PI/2?(n(e,t,r,Math.PI,o),n(e,t,Math.PI,3*Math.PI/2,o),n(e,t,3*Math.PI/2,a)):r>=Math.PI&&r<3*Math.PI/2&&a>3*Math.PI/2?(n(e,t,r,3*Math.PI/2,o),n(e,t,3*Math.PI/2,a,o)):n(e,t,r,a,o)}var l=this,f=r.config.layer,u=e.getGradientColor(r.config.style.statColor,"#ddd",f.statTag.length+1).slice(0,f.statTag.length),h=0,y=0;return r._features.forEach(function(e){e.attributes.totalValue=0,f.statTag.forEach(function(t){e.attributes.totalValue+=e.attributes[t]}),h=e.attributes.totalValue>h?e.attributes.totalValue:h,y=e.attributes.totalValue<y?e.attributes.totalValue:y}),r._features.forEach(function(e){var a=e.geometry,n=a.getCentroid(),l=0,y=0,p=(r._features[0]._extent.ymax-r._features[0]._extent.ymin)/6,m=0==h?p:p*e.attributes.totalValue/h;f.statTag.forEach(function(a,f){var h=e.attributes[a];y=0==e.attributes.totalValue?0:l+2*Math.PI*h/e.attributes.totalValue;var p=(new c).setColor(u[f]);if(p.setOutline(new g(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new t([60,60,60,.6]),1)),0!=h){if(h===e.attributes.totalValue)var w=new i(n,{radius:m});else{var M=[];M.push([n.x,n.y]),s(n,M,l,y,m),M.push([n.x,n.y]),w=new o(M)}r.drawLayer.add(new d(w,p)),l=y}})}),a(),l},b.prototype.drawHeat=function(e){var t=this,r=Array.prototype.slice.call(e.config.style.colorStops,0),a=new M({colorStops:r,blurRadius:e.config.style.heatPower,maxPixelIntensity:150,minPixelIntensity:0});return e.drawLayer.setRenderer(a),t},b.prototype.checkParams=function(e){var t=this,r=e.config.layer,a=e.config.legend,o=e.config.label;if(!e.map)throw new Error("OTMap Error：[map] is required in config,use [setConfig] method to fix it");if(!r.url)throw new Error("OTMap Error：[url] is required in layer config,use [setConfig] or [setLayer] method to fix it");if(a.show&&!a.id)throw new Error("OTMap Error：[id] is required in label config,use [setConfig] method to fix it");if(o.show&&!o.field)throw new Error("OTMap Error：[field] is required in label config,use [setConfig] method to fix it");switch(e.type){case"Range":if(!r.baseTag)throw new Error("OTMap Error：some required params absent in layer config,use [setConfig] or [setLayer] method to fix it");break;case"Histogram":case"Pie":if(!r.statTag.length)throw new Error("OTMap Error：some required params absent in layer config,use [setConfig] or [setLayer] method to fix it");if(!e.config.layer.simple&&!r.corString.length)throw new Error("OTMap Error：if [simple] is false,[corString] is required,use [setConfig] or [setLayer] method to fix it");break;case"Heat":}return t},b.prototype.getCorData=function(e,t,r,a){for(var o=0;o<e.length;o++){var n=0;if(r.forEach(function(r){var a=r.substring(0,r.indexOf("=")),i=r.substring(r.indexOf("=")+1);a.indexOf("&")<0?e[o][a]==t.attributes[i]&&n++:(a=a.substring(1),e[o][a]==i&&n++)}),n==r.length&&0!=n){var i=parseFloat(e[o][a]);return i=isNaN(i)?0:i}}return!1},new b});